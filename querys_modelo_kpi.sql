use santanderdb;

--Tabla madre sessions_table --

CREATE TABLE SESSIONS_TABLE (
    USER_ID  NUMERIC(38,0) NOT NULL,
    SESSION_ID NUMERIC(38,0) NOT NULL,
    SEGMENT_ID NUMERIC(10,0),
    SEGMENT_DESCRIPTION VARCHAR(100),
    USER_CITY VARCHAR(50),
    SERVER_TIME TIMESTAMP,
    DEVICE_BROWSER VARCHAR(10),
    DEVICE_OS VARCHAR(5),
    DEVICE_MOBILE VARCHAR(10),
    TIME_SPENT NUMERIC(38,0),
    EVENT_ID NUMERIC(38,0),
    EVENT_DESCRIPTION VARCHAR(50),
    CRASH_DETECTION VARCHAR(100),
    PRIMARY KEY (USER_ID, SESSION_ID)
);

-- Tabla para mostrar primer logueo de cada usuario--

CREATE TABLE  FIRST_USER_LOG (
    USER_ID NUMERIC(38,0) NOT NULL,
    SESSION_ID NUMERIC(38,0) NOT NULL,
    FIRST_DATE TIMESTAMP,
    PRIMARY KEY (USER_ID, SESSION_ID),
    FOREIGN KEY (USER_ID, SESSION_ID) REFERENCES SESSIONS_TABLE(USER_ID, SESSION_ID) ON DELETE CASCADE
);

--Tabla que muestra actividad de cada usuario por dia--

CREATE TABLE DAILY_USERS_ACTIVITY (
    ACTIVITY_DATE TIMESTAMP,
    USER_ID NUMERIC(38) NOT NULL,
    SESSION_ID NUMERIC(38,0) NOT NULL,
    EVENT_ID NUMERIC(38,0),
    TIME_SPENT NUMERIC(38,0),
    PRIMARY KEY (USER_ID, SESSION_ID),
    FOREIGN KEY (USER_ID, SESSION_ID) REFERENCES SESSIONS_TABLE(USER_ID, SESSION_ID) ON DELETE CASCADE
);

--Inserto registros de muestra a SESSIONS_TABLE--

INSERT INTO SESSIONS_TABLE VALUES(0001, 111111, 03, 'un_segmento', 'Santa Fe', '2021-09-01 00:01:30', 'CHROME', 'WIN', '', 310, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0002, 111112, 03, 'un_segmento', 'Santa Fe', '2021-09-01 02:00:45', 'CHROME', 'WIN', '', 420, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0003, 111113, 03, 'un_segmento', 'Santa Fe', '2021-09-01 12:01:00', 'CHROME', 'WIN', '', 530, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0004, 111114, 03, 'un_segmento', 'Santa Fe', '2021-09-01 13:08:30', 'CHROME', 'WIN', '', 640, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0005, 111115, 03, 'un_segmento', 'Santa Fe', '2021-09-01 15:15:20', 'CHROME', 'WIN', '', 347, 01, 'Login', '');

INSERT INTO SESSIONS_TABLE VALUES(0001, 111116, 03, 'un_segmento', 'Santa Fe', '2021-09-02 00:01:30', 'CHROME', 'WIN', '', 410, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0001, 111117, 03, 'un_segmento', 'Santa Fe', '2021-09-02 00:02:30', 'CHROME', 'WIN', '', 430, 02, 'Transf', '');
INSERT INTO SESSIONS_TABLE VALUES(0002, 111118, 03, 'un_segmento', 'Santa Fe', '2021-09-02 07:01:30', 'CHROME', 'WIN', '', 310, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0002, 111119, 03, 'un_segmento', 'Santa Fe', '2021-09-02 07:02:30', 'CHROME', 'WIN', '', 330, 02, 'Transf', '');
INSERT INTO SESSIONS_TABLE VALUES(0003, 111120, 03, 'un_segmento', 'Santa Fe', '2021-09-02 09:01:30', 'CHROME', 'WIN', '', 310, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0003, 111121, 03, 'un_segmento', 'Santa Fe', '2021-09-02 09:02:30', 'CHROME', 'WIN', '', 530, 02, 'Transf', '');
INSERT INTO SESSIONS_TABLE VALUES(0004, 111122, 03, 'un_segmento', 'Santa Fe', '2021-09-02 10:01:30', 'CHROME', 'WIN', '', 510, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0004, 111123, 03, 'un_segmento', 'Santa Fe', '2021-09-02 10:02:30', 'CHROME', 'WIN', '', 530, 02, 'Transf', '');
INSERT INTO SESSIONS_TABLE VALUES(0005, 111124, 03, 'un_segmento', 'Santa Fe', '2021-09-02 11:01:30', 'CHROME', 'WIN', '', 610, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0005, 111125, 03, 'un_segmento', 'Santa Fe', '2021-09-02 11:02:30', 'CHROME', 'WIN', '', 430, 02, 'Transf', '');

INSERT INTO SESSIONS_TABLE VALUES(0001, 111126, 03, 'un_segmento', 'Santa Fe', '2021-09-03 00:01:30', 'CHROME', 'WIN', '', 610, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0001, 111127, 03, 'un_segmento', 'Santa Fe', '2021-09-03 00:02:30', 'CHROME', 'WIN', '', 330, 02, 'Transf', '');
INSERT INTO SESSIONS_TABLE VALUES(0002, 111128, 03, 'un_segmento', 'Santa Fe', '2021-09-03 07:01:30', 'CHROME', 'WIN', '', 310, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0003, 111129, 03, 'un_segmento', 'Santa Fe', '2021-09-03 09:01:30', 'CHROME', 'WIN', '', 410, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0004, 111130, 03, 'un_segmento', 'Santa Fe', '2021-09-03 10:01:30', 'CHROME', 'WIN', '', 410, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0004, 111131, 03, 'un_segmento', 'Santa Fe', '2021-09-03 10:02:30', 'CHROME', 'WIN', '', 530, 02, 'Transf', '');
INSERT INTO SESSIONS_TABLE VALUES(0005, 111132, 03, 'un_segmento', 'Santa Fe', '2021-09-03 11:01:30', 'CHROME', 'WIN', '', 310, 01, 'Login', '');
INSERT INTO SESSIONS_TABLE VALUES(0005, 111133, 03, 'un_segmento', 'Santa Fe', '2021-09-03 11:02:30', 'CHROME', 'WIN', '', 330, 02, 'Transf', '');
    

--Inserto informacion sobre primer logueo--

INSERT INTO FIRST_USER_LOG (USER_ID, SESSION_ID, FIRST_DATE)

SELECT A.USER_ID, A.SESSION_ID, B.FECHA_PRIMER_LOGUEO 
FROM SESSIONS_TABLE A
INNER JOIN 
(
SELECT 
    USER_ID, MIN(SERVER_TIME) AS FECHA_PRIMER_LOGUEO FROM SESSIONS_TABLE WHERE EVENT_ID = 01
GROUP BY USER_ID
) B
ON A.SERVER_TIME = B.FECHA_PRIMER_LOGUEO


--Inserto ionformacion de actividad diaria--

INSERT INTO DAILY_USERS_ACTIVITY (ACTIVITY_DATE, USER_ID, SESSION_ID, EVENT_ID, TIME_SPENT)

SELECT DATE(SERVER_TIME) AS DIA, USER_ID, SESSION_ID, EVENT_ID,  SUM(TIME_SPENT) AS TIME_SPENT
FROM SESSIONS_TABLE
GROUP BY DIA, USER_ID, SESSION_ID, EVENT_ID



--Query para extraer el KPI de retencion de clientes los 10 clientes que las se loguearon en el ultimo mes--

SELECT SUM(COALESCE(freq_users.FREQUENT_USER,0)) / COUNT(*) AS PORCENTAJE_FREC_TOP 
FROM 
(SELECT USER_ID, COUNT(*) AS CANT FROM SESSIONS_TABLE WHERE EVENT_ID = 01
GROUP BY USER_ID ORDER BY CANT DESC LIMIT 10) top_users
LEFT JOIN 
(SELECT DISTINCT(b.USER_ID) as USER_ID, 1 AS FREQUENT_USER
FROM
(
SELECT t.USER_ID,
t.SERVER_TIME, 
DATEDIFF(t.SERVER_TIME, LAG(t.SERVER_TIME, 1) OVER (PARTITION BY t.USER_ID  ORDER BY t.SERVER_TIME )) as DIFF
FROM SESSIONS_TABLE t 
WHERE t.EVENT_ID <> 01 
AND TIME_SPENT >= 300
) b
WHERE b.DIFF >=1)  freq_users
on top_users.USER_ID = freq_users.USER_ID